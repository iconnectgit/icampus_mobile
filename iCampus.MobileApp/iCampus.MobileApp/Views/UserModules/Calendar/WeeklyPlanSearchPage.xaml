<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Name="weeklyplansearchpage"
             xmlns:local="clr-namespace:iCampus.MobileApp.Forms"
             xmlns:input="clr-namespace:InputKit.Shared.Controls;assembly=InputKit.Maui"
             xmlns:behaviours="clr-namespace:iCampus.MobileApp.Behaviours"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             xmlns:controls="clr-namespace:iCampus.MobileApp.Controls"
             xmlns:individual="clr-namespace:iCampus.MobileApp.Behaviours.Individual"
             x:Class="iCampus.MobileApp.Views.UserModules.Calendar.WeeklyPlanSearchPage"
             BackgroundColor="{Binding Settings.BgColor, Source={x:Static local:AppSettings.Current}}"
             NavigationPage.HasNavigationBar="false">
    <ContentPage.Content>
        
        <Grid>
            <Grid.Resources>
                <behaviours:IntToBoolValueConverter x:Key="intToBoolValueConverter" />
                <behaviours:ReverseBoolValueConverter x:Key="ReverseBoolValueConverter" />
                <behaviours:VisiblityConverter x:Key="visiblityConverter" />
                <individual:AgendaCancellationTextConverter x:Key="AgendaCancellationTextConverter" />
            </Grid.Resources>
            <Grid BackgroundColor="WhiteSmoke" RowDefinitions="Auto,*" VerticalOptions="FillAndExpand">
                <ContentView ControlTemplate="{StaticResource BeamHeader}"
                             BackgroundColor="White"  Grid.Row="0"/>
                <ScrollView Grid.Row="1" VerticalOptions="FillAndExpand" Margin="0,0,0,10">
                    <StackLayout  Spacing="5" Padding="10" Orientation="Vertical" VerticalOptions="FillAndExpand">

                        <!-- Show All Weeks Row -->
                        <StackLayout Orientation="Horizontal" HorizontalOptions="StartAndExpand" Margin="0,0,0,0">
                            <input:CheckBox IsChecked="{Binding IsAllWeekSelected, Mode=TwoWay}"
                                            VerticalOptions="CenterAndExpand"
                                            Text="Show All Weeks"
                                            Color="Gray"
                                            CheckChangedCommand="{Binding ShowAllWeeksCommand}" />
                        </StackLayout>    
                        
                        <!-- Date Range -->
                        <Label Text="Date Range" Margin="0,0,0,5"
                               Style="{StaticResource TitleLabelStyle}"
                               VerticalOptions="Start"
                               VerticalTextAlignment="Start" />

                        <Grid HeightRequest="40" BackgroundColor="White" HorizontalOptions="FillAndExpand">
                            <Picker Style="{StaticResource PickerFontStyle}"
                                    BackgroundColor="White"
                                    TextColor="Gray"
                                    ItemsSource="{Binding DateRangeList, Mode=TwoWay}" 
                                    ItemDisplayBinding="{Binding ItemName}" 
                                    SelectedItem="{Binding SelectedDateRangeList, Mode=TwoWay}"
                                    VerticalOptions="Center" 
                                    HorizontalOptions="FillAndExpand" />
                            <Image Source="dropdown_gray_picker"
                                   HorizontalOptions="End"
                                   VerticalOptions="Center"
                                   WidthRequest="20"
                                   HeightRequest="20"
                                   Margin="0,0,10,0" />
                        </Grid>

                        <!-- Grade -->
                        <Label Text="Grade" Margin="0,0,0,5"
                               IsVisible="{Binding IsGradeListVisible}"
                               Style="{StaticResource TitleLabelStyle}"
                               VerticalOptions="Start"
                               VerticalTextAlignment="Start" />

                        <Grid HeightRequest="40" BackgroundColor="White" HorizontalOptions="FillAndExpand" IsVisible="{Binding IsGradeListVisible}">
                            <Picker Title="Select"
                                    Style="{StaticResource PickerFontStyle}"
                                    BackgroundColor="White"
                                    TextColor="Gray"
                                    ItemsSource="{Binding GradeList, Mode=TwoWay}" 
                                    ItemDisplayBinding="{Binding ItemName}" 
                                    SelectedItem="{Binding SelectedGradeList, Mode=TwoWay}"
                                    VerticalOptions="Center" 
                                    HorizontalOptions="FillAndExpand" />
                            <Image Source="dropdown_gray_picker"
                                   HorizontalOptions="End"
                                   VerticalOptions="Center"
                                   WidthRequest="20"
                                   HeightRequest="20"
                                   Margin="0,0,10,0" />
                        </Grid>
                        
                        <!-- Course -->
                        <Label Text="Course" Margin="0,0,0,5"
                               Style="{StaticResource TitleLabelStyle}"
                               VerticalOptions="Start"
                               VerticalTextAlignment="Start" />

                        <Grid HeightRequest="40" BackgroundColor="White" HorizontalOptions="FillAndExpand">
                            <Picker Title="Select"
                                    Style="{StaticResource PickerFontStyle}"
                                    BackgroundColor="White"
                                    TextColor="Gray"
                                    ItemsSource="{Binding CourseList, Mode=TwoWay}" 
                                    ItemDisplayBinding="{Binding CurriculumName}" 
                                    SelectedItem="{Binding SelectedCourseList, Mode=TwoWay}"
                                    VerticalOptions="Center" 
                                    HorizontalOptions="FillAndExpand" />
                            <Image Source="dropdown_gray_picker"
                                   HorizontalOptions="End"
                                   VerticalOptions="Center"
                                   WidthRequest="20"
                                   HeightRequest="20"
                                   Margin="0,0,10,0" />
                        </Grid>
                        <!-- Class -->
                        <Label Text="Class" Margin="0,0,0,5"
                               IsVisible="{Binding IsClassListVisible}"
                               Style="{StaticResource TitleLabelStyle}"
                               VerticalOptions="Start"
                               VerticalTextAlignment="Start" />

                        <Grid HeightRequest="40" BackgroundColor="White" HorizontalOptions="FillAndExpand" IsVisible="{Binding IsClassListVisible}">
                            <Picker Title="Select"
                                    Style="{StaticResource PickerFontStyle}"
                                    BackgroundColor="White"
                                    TextColor="Gray"
                                    ItemsSource="{Binding ClassList, Mode=TwoWay}" 
                                    ItemDisplayBinding="{Binding ItemName}" 
                                    SelectedItem="{Binding SelectedClassList, Mode=TwoWay}"
                                    VerticalOptions="Center" 
                                    HorizontalOptions="FillAndExpand" />
                            <Image Source="dropdown_gray_picker"
                                   HorizontalOptions="End"
                                   VerticalOptions="Center"
                                   WidthRequest="20"
                                   HeightRequest="20"
                                   Margin="0,0,10,0" />
                        </Grid>
                        
                        <Button Text="Search" TextColor="White" CornerRadius="5" Margin="0,10,0,0"
                                BackgroundColor="{Binding Settings.ThemeColor, Source={x:Static local:AppSettings.Current}}"
                                HorizontalOptions="FillAndExpand" Command="{Binding SearchClickCommand}" />
                        
                        <StackLayout Padding="0,10,0,0" Margin="0,0,5,0" VerticalOptions="StartAndExpand"
                                     IsVisible="{Binding IsWeeklyNoRecordMsg}">
                        
                            <Frame Padding="10" HasShadow="False"
                                   CornerRadius="5"
                                   IsClippedToBounds="True"
                                   BorderColor="{StaticResource BorderColor}"
                                   BackgroundColor="White">
                                <Label Text="No weekly records are currently available" Style="{StaticResource DescriptionLabelStyle}"
                                       VerticalTextAlignment="Center"
                                       HorizontalTextAlignment="Start" />
                            </Frame>
                        </StackLayout>
                        
                        <Frame HasShadow="False" Padding="5" VerticalOptions="Start"
                               BackgroundColor="Transparent" HorizontalOptions="EndAndExpand"
                               BorderColor="#E8E8E8"
                               IsVisible="{Binding IsExportToPDFVisisble}">
                                <Label HorizontalOptions="Start" 
                                       VerticalOptions="CenterAndExpand"
                                       Margin="5,0,0,0"
                                       Text="Export To PDF" 
                                       Style="{StaticResource DescriptionLabelStyle }" />
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ExportToPDFClickCommand}" />
                                </Frame.GestureRecognizers>
                        </Frame>
                        <StackLayout VerticalOptions="FillAndExpand" Spacing="0">
                        <ListView HasUnevenRows="true" Margin="5,0,5,0"
                                  ItemsSource="{Binding AgendaWeeklyGroupList, Mode=TwoWay}"
                                  SelectedItem="{Binding SelectedAgendaWeeklyGroupList, Mode=TwoWay}"
                                  SeparatorVisibility="None" VerticalScrollBarVisibility="Never"
                                  BackgroundColor="{StaticResource ListViewBackgroundColor}"
                                  IsGroupingEnabled="True"
                                  SelectionMode="None" 
                                  x:Name="beamWeeklyPlanList">
                            <x:Arguments>
                                <ListViewCachingStrategy>RecycleElementAndDataTemplate</ListViewCachingStrategy>
                            </x:Arguments>
                            <ListView.GroupHeaderTemplate>
                                <DataTemplate>
                                    <ViewCell>
                                        <Frame Padding="2" HasShadow="False" CornerRadius="0" BorderColor="Transparent">
                                            <Label Text="{Binding Key}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   FontFamily=""
                                                   Padding="0"
                                                   Style="{StaticResource TitleLabelStyle}"
                                                   VerticalTextAlignment="Center"
                                                   VerticalOptions="CenterAndExpand" />
                                        </Frame>
                                    </ViewCell>
                                </DataTemplate>
                            </ListView.GroupHeaderTemplate>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <ViewCell>
                                        <StackLayout Padding="2" Spacing="0">

                                            <!-- Item Header -->
                                            <Frame CornerRadius="0" HasShadow="False" 
                                                   BorderColor="{StaticResource BorderColor}" Padding="1"
                                                   IsClippedToBounds="true">
                                                <StackLayout BackgroundColor="White" VerticalOptions="CenterAndExpand" Spacing="0">
                                                    <Frame Padding="0" HasShadow="False" CornerRadius="5"
                                                           BorderColor="Transparent">
                                                        <Grid RowSpacing="0" Padding="5,0,5,0">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto" />
                                                            </Grid.RowDefinitions>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="0.6*" />
                                                                <ColumnDefinition Width="0.4*" />
                                                            </Grid.ColumnDefinitions>

                                                            <Label Style="{StaticResource TitleLabelStyle}"
                                                                   FontSize="14"
                                                                   FontFamily=""
                                                                   Grid.Row="0"
                                                                   Text="{Binding CurriculumName}"
                                                                   IsVisible="{Binding CurriculumName, Converter={StaticResource visiblityConverter}}"
                                                                   Grid.Column="0"
                                                                   Grid.ColumnSpan="2" 
                                                                   VerticalOptions="Center"/>

                                                            <ffimageloading:CachedImage
                                                                Source="{Binding ArrowImageSource}"
                                                                Grid.Row="0"
                                                                Grid.Column="1"
                                                                HorizontalOptions="EndAndExpand"
                                                                Scale="0.8">
                                                                <ffimageloading:CachedImage.GestureRecognizers>
                                                                    <TapGestureRecognizer
                                                                        Command="{Binding BindingContext.WeeklyExpandCollapseClickCommand, Source={x:Reference beamWeeklyPlanList}}"
                                                                        CommandParameter="{Binding .}" />
                                                                </ffimageloading:CachedImage.GestureRecognizers>
                                                            </ffimageloading:CachedImage>
                                                        </Grid>
                                                        <Frame.GestureRecognizers>
                                                            <TapGestureRecognizer
                                                                Command="{Binding BindingContext.WeeklyExpandCollapseClickCommand, Source={x:Reference beamWeeklyPlanList}}"
                                                                CommandParameter="{Binding .}" />
                                                        </Frame.GestureRecognizers>
                                                    </Frame>
                                                </StackLayout>
                                            </Frame>

                                            <!-- Expand/Collapse Details -->
                                            <Frame CornerRadius="5"
                                                   Padding="0"
                                                   HasShadow="False"
                                                   IsVisible="{Binding WeeklyPostDetailsVisibility}"
                                                   IsClippedToBounds="True"
                                                   BorderColor="Transparent"
                                                   Margin="0,5,0,0">

                                                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto"
                                                      RowSpacing="2"
                                                      ColumnDefinitions="*"
                                                      Padding="5,5,5,5">

                                                    <StackLayout Orientation="Vertical" Margin="0,0,0,5" Padding="0"
                                                                 Grid.Row="0">
                                                        <Label Text="Title" FontAttributes="Bold" FontFamily=""
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                        <Label Text="{Binding Title}" TextType="Html"
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                    </StackLayout>

                                                    <Label IsVisible="{Binding IsDeleted}"
                                                           Grid.Row="1"
                                                           Text="{Binding ., Converter={StaticResource AgendaCancellationTextConverter}}"
                                                           TextColor="Red" />

                                                    <StackLayout Grid.Row="2" Padding="0"
                                                                 IsVisible="{Binding IsTeacher, Source={x:Static local:AppSettings.Current}}">
                                                        <Label Text="Approved"
                                                               Style="{StaticResource TitleLabelStyle}"
                                                               IsVisible="{Binding BindingContext.CalendarApprovalPermissions.IsAgendaApproval, Source={x:Reference beamWeeklyPlanList}}"
                                                               TextColor="{StaticResource ApprovedTextColor}" />
                                                        <Label Text="Pending"
                                                               Style="{StaticResource TitleLabelStyle}"
                                                               IsVisible="{Binding BindingContext.CalendarApprovalPermissions.IsAgendaApproval, Source={x:Reference beamWeeklyPlanList}, Converter={StaticResource ReverseBoolValueConverter}}"
                                                               TextColor="{StaticResource PendingTextColor}" />
                                                    </StackLayout>

                                                    <StackLayout Orientation="Vertical" Padding="0" Grid.Row="3">
                                                        <Label Text="Curriculum Standards" FontAttributes="Bold" FontFamily=""
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                        <Label Text="{Binding CurriculumStandards}" TextType="Html"
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                    </StackLayout>

                                                    <StackLayout Orientation="Vertical" Padding="0" Grid.Row="4">
                                                        <Label Text="Remarks" FontAttributes="Bold" FontFamily=""
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                        <Label Text="{Binding Remarks}" TextType="Html"
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                    </StackLayout>

                                                    <StackLayout Orientation="Vertical"
                                                                 IsVisible="{Binding IsTeacher, Source={x:Static local:AppSettings.Current}}"
                                                                 Padding="0" Grid.Row="5">
                                                        <Label Text="{Binding AgendaClassNames}" FontAttributes="Bold"
                                                               FontSize="12" FontFamily=""
                                                               Style="{StaticResource DescriptionLabelStyle}" />
                                                    </StackLayout>
                                                </Grid>
                                            </Frame>

                                        </StackLayout>
                                    </ViewCell>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                        </StackLayout>
                        <CollectionView Margin="5,5,5,0" 
                                        ItemsSource="{Binding GroupedAgendaData, Mode=TwoWay}"
                                        SelectedItem="{Binding SelectedGroupedAgendaData, Mode=TwoWay}"
                                        VerticalScrollBarVisibility="Never"
                                        BackgroundColor="{StaticResource ListViewBackgroundColor}"
                                        SelectionMode="None"
                                        VerticalOptions="StartAndExpand"
                                        x:Name="beamWeeklyGroupedAgendaList">

                            <CollectionView.ItemTemplate>
                                <DataTemplate>

                                    <Grid Padding="0,0,0,0" VerticalOptions="FillAndExpand">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <StackLayout Padding="2" Grid.Column="1"
                                                     VerticalOptions="FillAndExpand">
                                            <Frame Padding="5" HasShadow="False"
                                                   CornerRadius="0"
                                                   BorderColor="Transparent">
                                                <Label FontSize="16" Padding="0"
                                                       FontAttributes="Bold"
                                                       Text="{Binding DueDate}"
                                                       Style="{StaticResource TitleLabelStyle}"
                                                       FontFamily="" VerticalTextAlignment="Center"
                                                       VerticalOptions="CenterAndExpand" />
                                            </Frame>
                                            <Frame CornerRadius="0"
                                                   Margin="5,0,5,0"
                                                   HasShadow="False"
                                                   BorderColor="{StaticResource BorderColor}"
                                                   Padding="1"
                                                   IsClippedToBounds="true">
                                                <StackLayout BackgroundColor="White"
                                                             VerticalOptions="FillAndExpand">
                                                    <Frame Padding="0" HasShadow="False"
                                                           CornerRadius="5"
                                                           BorderColor="Transparent">
                                                        <Grid RowSpacing="1"
                                                              Padding="5,0,5,0">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto" />
                                                            </Grid.RowDefinitions>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="0.9*" />
                                                                <ColumnDefinition Width="0.1*" />
                                                            </Grid.ColumnDefinitions>
                                                            <Label Style="{StaticResource TitleLabelStyle}"
                                                                   FontSize="14"
                                                                   FontFamily=""
                                                                   VerticalOptions="Center"
                                                                   Grid.Row="0" Text="{Binding CurriculumName}"
                                                                   IsVisible="{Binding CurriculumName,Converter={StaticResource visiblityConverter}}"
                                                                   Grid.Column="0" Padding="0"
                                                                   Grid.ColumnSpan="2" />
                                                        </Grid>
                                                        <Frame.GestureRecognizers>
                                                            <TapGestureRecognizer
                                                                Command="{Binding BindingContext.GroupedAgendaDataCollapseClickCommand,Source={x:Reference beamWeeklyPlanList}}"
                                                                CommandParameter="{Binding .}" />
                                                        </Frame.GestureRecognizers>
                                                    </Frame>
                                                </StackLayout>
                                            </Frame>
                                        </StackLayout>
                                    </Grid>

                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </ScrollView>
                
                
                <Grid.GestureRecognizers>
                    <SwipeGestureRecognizer
                        Command="{Binding BindingContext.SideMenuClickCommand, Source={x:Reference weeklyplansearchpage}}"
                        Direction="Right" />
                </Grid.GestureRecognizers>
            </Grid>
        </Grid>
        
    </ContentPage.Content>
</ContentPage>